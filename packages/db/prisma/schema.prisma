datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  name          String?
  password      String?
  role          String        @default("customer") // customer, admin, partner
  phone         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  orders        Order[]
  prescriptions Prescription[]
  addresses     Address[]
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String   // Home, Work, etc.
  street      String
  city        String
  state       String
  postalCode  String
  country     String   @default("IN")
  latitude    Float?
  longitude   Float?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model Pharmacy {
  id            String      @id @default(cuid())
  name          String
  address       String
  latitude      Float
  longitude     Float
  phone         String?
  email         String?
  verified      Boolean     @default(false)
  rating        Float?      @default(0)
  ratingCount   Int         @default(0)
  deliveryFee   Float        @default(0)
  minOrderValue Float        @default(0)
  estimatedDeliveryMinutes Int? // Average delivery time in minutes
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  inventory     Inventory[]
  orders        Order[]
  reviews       Review[]

  @@index([latitude, longitude])
}

model Product {
  id            String        @id @default(cuid())
  name          String
  brand         String?
  genericName   String?
  description   String?
  rxRequired    Boolean       @default(false)
  sideEffects   String?
  interactions  String?
  dosage        String?
  manufacturer  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  inventory     Inventory[]
  priceRecords  PriceRecord[]
  orderItems    OrderItem[]
  reviews       Review[]

  @@index([name])
  @@index([genericName])
}

model Inventory {
  id          String   @id @default(cuid())
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  pharmacyId  String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String
  price       Float
  quantity    Int      @default(0)
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([pharmacyId, productId])
  @@index([pharmacyId])
  @@index([productId])
}

model PriceRecord {
  id          String   @id @default(cuid())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   String
  pharmacyId  String
  price       Float
  recordedAt  DateTime @default(now())

  @@index([productId])
  @@index([pharmacyId])
}

model Order {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  pharmacy      Pharmacy?     @relation(fields: [pharmacyId], references: [id])
  pharmacyId   String?
  totalAmount   Float
  deliveryFee   Float          @default(0)
  status        OrderStatus   @default(PENDING)
  deliveryETA   DateTime?
  deliveryAddress String
  paymentStatus PaymentStatus @default(PENDING)
  items         OrderItem[]
  prescription  Prescription? @relation(fields: [prescriptionId], references: [id])
  prescriptionId String?      @unique
  payment       Payment?
  tracking      OrderTracking?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([pharmacyId])
  @@index([status])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PACKED
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model OrderItem {
  id         String  @id @default(cuid())
  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId    String
  product    Product @relation(fields: [productId], references: [id])
  productId  String
  quantity   Int
  unitPrice  Float
  createdAt  DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

model Prescription {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  fileUrl    String
  fileName   String?
  fileType   String?  // image/jpeg, application/pdf
  verifiedBy String?  // pharmacy or admin id who verified
  verifiedAt DateTime?
  status     PrescriptionStatus @default(PENDING)
  order      Order?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum PrescriptionStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Payment {
  id          String       @id @default(cuid())
  order       Order        @relation(fields: [orderId], references: [id])
  orderId     String       @unique
  provider    String       // stripe, razorpay, cod
  providerId  String?      // External payment ID
  amount      Float
  status      PaymentStatus @default(PENDING)
  metadata    Json?        // Additional payment data
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([orderId])
  @@index([providerId])
}

model OrderTracking {
  id          String   @id @default(cuid())
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String   @unique
  currentLat  Float?
  currentLng  Float?
  courierName String?
  courierPhone String?
  status      OrderStatus
  estimatedArrival DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Review {
  id          String   @id @default(cuid())
  userId      String
  productId   String?
  pharmacyId  String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  pharmacy    Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  rating      Int      // 1-5
  comment     String?
  verified    Boolean  @default(false) // Verified purchase
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([pharmacyId])
  @@index([userId])
}

